<main class="container mt-4">
    <h2 class="text-center mb-4">éšŠä¼ç®¡ç†</h2>

    <div id="manager-data" data-is-manager="<%= isManager || 'N' %>"></div>

    <!-- æ–°å¢æˆå“¡æŒ‰éˆ• -->
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal">æ–°å¢æˆå“¡</button>
    </div>

    <!-- äººå“¡åˆ—è¡¨ -->
    <table class="table table-striped text-center">
        <thead class="table-dark">
            <tr>
                <th>å§“å</th>
                <th>è§’è‰²</th>
                <th>èƒŒè™Ÿ</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            <% if (players.length> 0) { %>
                <% players.forEach((player)=> { %>
                    <tr>
                        <td>
                            <%= player.player_name %>
                        </td>
                        <td>
                            <%= player.role %>
                        </td>
                        <td>
                            <%= player.number %>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm"
                                onclick="viewPlayer('<%= player.player_name %>', '<%= player.role %>', '<%= player.number %>')">æª¢è¦–</button>
                            <button class="btn btn-warning btn-sm"
                                onclick="editPlayer('<%= player.player_id %>')">ä¿®æ”¹</button>
                            <button class="btn btn-danger btn-sm"
                                onclick="deletePlayer('<%= player.player_id %>')">åˆªé™¤</button>
                        </td>
                    </tr>
                    <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="4">ç›®å‰æ²’æœ‰çƒå“¡</td>
                            </tr>
                            <% } %>
        </tbody>
    </table>

    <!-- æ“ä½œæŒ‰éˆ•å€åŸŸ -->
    <div class="d-flex justify-content-center gap-3 mt-4">
        <button class="btn btn-primary btn-lg" id="startMatchBtn">æ¯”è³½é–‹å§‹</button>
        <button class="btn btn-primary btn-lg text-white" id="viewStatsBtn">æ•¸æ“šæª¢è¦–</button>
        <button class="btn btn-primary btn-lg text-white" id="viewMatchesBtn">å°å±€æ­·å²</button>
    </div>
</main>

<!-- æ–°å¢éšŠå“¡ Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMemberModalLabel">æ–°å¢çƒå“¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPlayerForm">
                    <div class="mb-3">
                        <label for="playerName" class="form-label">å§“å</label>
                        <input type="text" class="form-control" id="playerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="playerRole" class="form-label">è§’è‰²</label>
                        <input type="text" class="form-control" id="playerRole" required>
                    </div>
                    <div class="mb-3">
                        <label for="playerNumber" class="form-label">èƒŒè™Ÿ</label>
                        <input type="number" class="form-control" id="playerNumber" required>
                    </div>
                    <button type="submit" class="btn btn-primary">æ–°å¢</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- é¸æ“‡æ¯”è³½çƒå“¡ Modal -->
<div class="modal fade" id="selectPlayersModal" tabindex="-1" aria-labelledby="selectPlayersModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectPlayersModalLabel">é¸æ“‡ä¸Šå ´çƒå“¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="selectPlayersForm">
                    <div id="playersList"></div>
                    <button type="submit" class="btn btn-primary mt-3">é–‹å§‹æ¯”è³½</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    document.getElementById("addPlayerForm").addEventListener("submit", function (event) {
        let isManager = document.getElementById('manager-data').dataset.isManager === "Y";
        if (isManager) {
            event.preventDefault();

            const playerName = document.getElementById("playerName").value;
            const playerRole = document.getElementById("playerRole").value;
            const playerNumber = document.getElementById("playerNumber").value;

            fetch("/manager/addPlayer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    player_name: playerName,
                    role: playerRole,
                    number: playerNumber
                })
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => console.error("Error:", error));
        } else {
            alert("è©²å¸³è™Ÿç„¡æ­¤æ¬Šé™");
        }

    });

    function viewPlayer(name, role, number) {
        alert(`å§“å: ${name}\nè§’è‰²: ${role}\nèƒŒè™Ÿ: ${number}`);
    }

    function editPlayer(playerId) {
        alert(`ç·¨è¼¯çƒå“¡ ID: ${playerId}`);
    }

    function deletePlayer(playerId) {
        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çƒå“¡å—ï¼Ÿ")) {
            fetch(`/players/delete/${playerId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
        }
    }

    document.getElementById("startMatchBtn").addEventListener("click", function () {
        //åˆ¤æ–·è©²å¸³è™Ÿæ˜¯å¦æœ‰çƒéšŠç®¡ç†è€…æ¬Šé™
        let isManager = document.getElementById('manager-data').dataset.isManager === "Y";
        if (isManager) {
            fetch("/manager/players/list")
                .then(response => response.json())
                .then(data => {
                    const playersList = document.getElementById("playersList");
                    playersList.innerHTML = "";
                    data.players.forEach(player => {
                        const checkbox = document.createElement("div");
                        checkbox.classList.add("form-check");
                        checkbox.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="selectedPlayers" value="${player.player_id}" id="player_${player.player_id}">
                        <label class="form-check-label" for="player_${player.player_id}">
                            ${player.player_name} - ${player.role} (#${player.number})
                        </label>
                    `;
                        playersList.appendChild(checkbox);
                    });

                    new bootstrap.Modal(document.getElementById("selectPlayersModal")).show();

                })
                .catch(error => console.error("Error fetching players:", error));
        } else {
            alert("è©²å¸³è™Ÿç„¡æ­¤æ¬Šé™");
        }

    });

    document.getElementById("selectPlayersForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const selectedPlayers = [];
        document.querySelectorAll('input[name="selectedPlayers"]:checked').forEach(checkbox => {
            selectedPlayers.push(checkbox.value);
        });

        if (selectedPlayers.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€åçƒå“¡ï¼");
            return;
        }

        fetch("/match/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ players: selectedPlayers })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤");
                }
                return response.text(); // é€™è£¡ä½¿ç”¨ text()ï¼Œä½†ä¸è™•ç†å›æ‡‰å…§å®¹
            })
            .then(() => {
                window.location.href = "/match"; // ğŸ”¥ ç›´æ¥è·³è½‰åˆ° `/match`
            })
            .catch(error => console.error("Error starting match:", error));
    });

    document.getElementById("viewMatchesBtn").addEventListener("click", () => {
        window.location.href = "/matchHistory"; // å°å‘ matchHistory é é¢
    });

    document.getElementById('viewStatsBtn').addEventListener('click', function () {
        window.location.href = '/point/team-stats'; // å°å‘ API å–å¾—æ•¸æ“šä¸¦æ¸²æŸ“é é¢
    });
</script>
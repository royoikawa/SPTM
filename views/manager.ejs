<main class="container mt-4">
    <h2 class="text-center mb-4">éšŠä¼ç®¡ç†</h2>

    <div id="manager-data" data-is-manager="<%= isManager || 'N' %>"></div>

    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal">æ–°å¢æˆå“¡</button>
    </div>

    <table class="table table-striped text-center">
        <thead class="table-dark">
            <tr>
                <th>å§“å</th>
                <th>è§’è‰²</th>
                <th>èƒŒè™Ÿ</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            <% if (players.length> 0) { %>
                <% players.forEach((player)=> { %>
                    <tr class="player-row" data-name="<%= player.player_name %>" data-role="<%= player.role %>"
                        data-number="<%= player.number %>" data-id="<%= player.player_id %>">
                        <td class="text-primary fw-bold">
                            <%= player.player_name %>
                        </td>
                        <td>
                            <%= player.role %>
                        </td>
                        <td>
                            <%= player.number %>
                        </td>
                        <td>
                            <button class="btn btn-warning btn-sm"
                                onclick="editPlayer('<%= player.player_id %>')">ä¿®æ”¹</button>
                            <button class="btn btn-danger btn-sm"
                                onclick="deletePlayer('<%= player.player_id %>')">åˆªé™¤</button>
                        </td>
                    </tr>
                    <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="4">ç›®å‰æ²’æœ‰çƒå“¡</td>
                            </tr>
                            <% } %>
        </tbody>
    </table>

    <div class="d-flex justify-content-center gap-3 mt-4">
        <button class="btn btn-primary btn-lg btn-responsive" id="startMatchBtn">
            <span>æ¯”è³½</span><span>é–‹å§‹</span>
        </button>
        <button class="btn btn-primary btn-lg btn-responsive text-white" id="viewStatsBtn">
            <span>æ•¸æ“š</span><span>æª¢è¦–</span>
        </button>
        <button class="btn btn-primary btn-lg btn-responsive text-white" id="viewMatchesBtn">
            <span>å°å±€</span><span>æ­·å²</span>
        </button>
    </div>

    <!-- æ–°å¢éšŠå“¡ Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMemberModalLabel">æ–°å¢çƒå“¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPlayerForm">
                        <div class="mb-3">
                            <label for="playerName" class="form-label">å§“å</label>
                            <input type="text" class="form-control" id="playerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="playerRole" class="form-label">è§’è‰²</label>
                            <input type="text" class="form-control" id="playerRole" required>
                        </div>
                        <div class="mb-3">
                            <label for="playerNumber" class="form-label">èƒŒè™Ÿ</label>
                            <input type="number" class="form-control" id="playerNumber" required>
                        </div>
                        <button type="submit" class="btn btn-primary">æ–°å¢</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- é¸æ“‡æ¯”è³½çƒå“¡ Modal -->
    <div class="modal fade" id="selectPlayersModal" tabindex="-1" aria-labelledby="selectPlayersModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectPlayersModalLabel">é¸æ“‡ä¸Šå ´çƒå“¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="selectPlayersForm">
                        <div id="playersList"></div>
                        <button type="submit" class="btn btn-primary mt-3">é–‹å§‹æ¯”è³½</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- é€™æ˜¯å½ˆå‡ºè¦–çª—çš„ HTML (Modal) -->
    <div class="modal fade" id="playerStatsModal" tabindex="-1" aria-labelledby="playerStatsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playerStatsModalLabel">å„é …æ•¸å€¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <canvas id="playerRadarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</main>

<style>
    .player-row {
        cursor: pointer;
    }

    .btn-responsive {
        white-space: nowrap;
        /* é˜²æ­¢è‡ªå‹•æ›è¡Œ */
        padding: 10px 15px;
        /* å¢åŠ æŒ‰éˆ•å…§è· */
        text-align: center;
    }

    @media (max-width: 576px) {

        /* é‡å°æ‰‹æ©Ÿ */
        .btn-responsive {
            display: inline-block;
            width: 90px;
            /* æ§åˆ¶æ¯å€‹æŒ‰éˆ•å¯¬åº¦ */
            text-align: center;
        }

        /* è®“å­—æ¯å…©å€‹å­—æ›è¡Œ */
        .btn-responsive span {
            display: block;
            line-height: 1.2;
        }
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.querySelectorAll('.player-row td.text-primary').forEach(nameCell => {
        nameCell.addEventListener('click', async function (event) {
            event.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
            let row = this.closest('.player-row');
            let playerId = row.dataset.id;

            try {
                const response = await fetch(`/point/points/${playerId}`);
                if (!response.ok) throw new Error('Failed to fetch data');

                const playerData = await response.json();
                if(playerData[0]==null){
                    alert('è©²çƒå“¡å°šç„¡æ•¸æ“š');
                }
                else{
                    showPlayerStats(playerData[0]);
                }
                
                
            } catch (error) {
                console.error('Error fetching player stats:', error);
            }
        });
    });

    function showPlayerStats(player) {
        const ctx = document.getElementById('playerRadarChart').getContext('2d');
        // å…ˆæ¸…é™¤èˆŠåœ–è¡¨ï¼Œé¿å…èˆŠåœ–è¡¨é–ƒç¾
        if (window.radarChart) {
            window.radarChart.destroy();
        }
        // é¡¯ç¤º modal
        new bootstrap.Modal(document.getElementById('playerStatsModal')).show();

        // åœ¨ Modal é¡¯ç¤ºå¾Œï¼Œå†åˆå§‹åŒ–åœ–è¡¨
        setTimeout(() => {

            window.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['æ”»æ“Š', 'é˜²å®ˆ', 'æ¥çƒ', 'èˆ‰çƒ', 'æ””ç¶²', 'ç™¼çƒ'],
                    datasets: [{
                        label: player.player_name,
                        data: [
                            0, 0, 0, 0, 0, 0 // åˆå§‹æ•¸æ“šç‚º 0
                        ],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: {
                        r: {
                            suggestedMin: 0,
                            suggestedMax: 1
                        }
                    },
                    animation: {
                        duration: 1500,  // è¨­å®šå‹•ç•«æ™‚é–“
                        easing: 'easeOutBounce',  // ä½¿ç”¨å½ˆæ€§çµæŸæ•ˆæœ
                        onComplete: function () {
                            console.log('å‹•ç•«å®Œæˆ');
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',  // å°‡åœ–ä¾‹ç½®å³
                            labels: {
                                boxWidth: 20,  // è‡ªå®šç¾©åœ–ä¾‹æ¡†çš„å¯¬åº¦
                                padding: 15     // è‡ªå®šç¾©åœ–ä¾‹é–“éš”
                            }
                        }
                    }
                }
            });

            // åœ¨åˆå§‹åŒ–å¾Œæ›´æ–°æ•¸æ“š
            window.radarChart.data.datasets[0].data = [
                player.attack_point,
                player.defense_point,
                player.receive_point,
                player.set_point,
                player.block_point,
                player.serve_point
            ];
            window.radarChart.update(); // æ›´æ–°åœ–è¡¨ï¼Œè§¸ç™¼å‹•ç•«
        }, 300);  // å»¶é² 300ms ä¿è­‰ modal å®Œå…¨é¡¯ç¤ºå¾Œå†ç¹ªè£½åœ–è¡¨
    }

    document.getElementById("addPlayerForm").addEventListener("submit", function (event) {
        let isManager = document.getElementById('manager-data').dataset.isManager === "Y";
        if (isManager) {
            event.preventDefault();

            const playerName = document.getElementById("playerName").value;
            const playerRole = document.getElementById("playerRole").value;
            const playerNumber = document.getElementById("playerNumber").value;

            fetch("/manager/addPlayer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    player_name: playerName,
                    role: playerRole,
                    number: playerNumber
                })
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => console.error("Error:", error));
        } else {
            alert("è©²å¸³è™Ÿç„¡æ­¤æ¬Šé™");
        }

    });

    function viewPlayer(name, role, number) {
        alert(`å§“å: ${name}\nè§’è‰²: ${role}\nèƒŒè™Ÿ: ${number}`);
    }

    function editPlayer(playerId) {
        alert(`ç·¨è¼¯çƒå“¡ ID: ${playerId}`);
    }

    function deletePlayer(playerId) {
        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çƒå“¡å—ï¼Ÿ")) {
            fetch(`/players/delete/${playerId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
        }
    }

    document.getElementById("startMatchBtn").addEventListener("click", function () {
        //åˆ¤æ–·è©²å¸³è™Ÿæ˜¯å¦æœ‰çƒéšŠç®¡ç†è€…æ¬Šé™
        let isManager = document.getElementById('manager-data').dataset.isManager === "Y";
        if (isManager) {
            fetch("/manager/players/list")
                .then(response => response.json())
                .then(data => {
                    const playersList = document.getElementById("playersList");
                    playersList.innerHTML = "";
                    data.players.forEach(player => {
                        const checkbox = document.createElement("div");
                        checkbox.classList.add("form-check");
                        checkbox.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="selectedPlayers" value="${player.player_id}" id="player_${player.player_id}">
                        <label class="form-check-label" for="player_${player.player_id}">
                            ${player.player_name} - ${player.role} (#${player.number})
                        </label>
                    `;
                        playersList.appendChild(checkbox);
                    });

                    new bootstrap.Modal(document.getElementById("selectPlayersModal")).show();

                })
                .catch(error => console.error("Error fetching players:", error));
        } else {
            alert("è©²å¸³è™Ÿç„¡æ­¤æ¬Šé™");
        }

    });

    document.getElementById("selectPlayersForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const selectedPlayers = [];
        document.querySelectorAll('input[name="selectedPlayers"]:checked').forEach(checkbox => {
            selectedPlayers.push(checkbox.value);
        });

        if (selectedPlayers.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€åçƒå“¡ï¼");
            return;
        }

        fetch("/match/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ players: selectedPlayers })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤");
                }
                return response.text(); // é€™è£¡ä½¿ç”¨ text()ï¼Œä½†ä¸è™•ç†å›æ‡‰å…§å®¹
            })
            .then(() => {
                window.location.href = "/match"; // ğŸ”¥ ç›´æ¥è·³è½‰åˆ° `/match`
            })
            .catch(error => console.error("Error starting match:", error));
    });

    document.getElementById("viewMatchesBtn").addEventListener("click", () => {
        window.location.href = "/matchHistory"; // å°å‘ matchHistory é é¢
    });

    document.getElementById('viewStatsBtn').addEventListener('click', function () {
        window.location.href = '/point/team-stats'; // å°å‘ API å–å¾—æ•¸æ“šä¸¦æ¸²æŸ“é é¢
    });

</script>
<main class="container mt-4">
    <h2 class="text-center mb-4">隊伍管理</h2>

    <div id="manager-data" data-is-manager="<%= isManager || 'N' %>"></div>

    <!-- 新增成員按鈕 -->
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal">新增成員</button>
    </div>

    <!-- 人員列表 -->
    <table class="table table-striped text-center">
        <thead class="table-dark">
            <tr>
                <th>姓名</th>
                <th>角色</th>
                <th>背號</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <% if (players.length> 0) { %>
                <% players.forEach((player)=> { %>
                    <tr>
                        <td>
                            <%= player.player_name %>
                        </td>
                        <td>
                            <%= player.role %>
                        </td>
                        <td>
                            <%= player.number %>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm"
                                onclick="viewPlayer('<%= player.player_name %>', '<%= player.role %>', '<%= player.number %>')">檢視</button>
                            <button class="btn btn-warning btn-sm"
                                onclick="editPlayer('<%= player.player_id %>')">修改</button>
                            <button class="btn btn-danger btn-sm"
                                onclick="deletePlayer('<%= player.player_id %>')">刪除</button>
                        </td>
                    </tr>
                    <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="4">目前沒有球員</td>
                            </tr>
                            <% } %>
        </tbody>
    </table>

    <!-- 操作按鈕區域 -->
    <div class="d-flex justify-content-center gap-3 mt-4">
        <button class="btn btn-primary btn-lg" id="startMatchBtn">比賽開始</button>
        <button class="btn btn-primary btn-lg text-white" id="viewStatsBtn">數據檢視</button>
        <button class="btn btn-primary btn-lg text-white" id="viewMatchesBtn">對局歷史</button>
    </div>
</main>

<!-- 新增隊員 Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMemberModalLabel">新增球員</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPlayerForm">
                    <div class="mb-3">
                        <label for="playerName" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="playerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="playerRole" class="form-label">角色</label>
                        <input type="text" class="form-control" id="playerRole" required>
                    </div>
                    <div class="mb-3">
                        <label for="playerNumber" class="form-label">背號</label>
                        <input type="number" class="form-control" id="playerNumber" required>
                    </div>
                    <button type="submit" class="btn btn-primary">新增</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 選擇比賽球員 Modal -->
<div class="modal fade" id="selectPlayersModal" tabindex="-1" aria-labelledby="selectPlayersModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectPlayersModalLabel">選擇上場球員</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="selectPlayersForm">
                    <div id="playersList"></div>
                    <button type="submit" class="btn btn-primary mt-3">開始比賽</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    document.getElementById("addPlayerForm").addEventListener("submit", function (event) {
        let isManager = document.getElementById('manager-data').dataset.isManager === "Y";
        if (isManager) {
            event.preventDefault();

            const playerName = document.getElementById("playerName").value;
            const playerRole = document.getElementById("playerRole").value;
            const playerNumber = document.getElementById("playerNumber").value;

            fetch("/manager/addPlayer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    player_name: playerName,
                    role: playerRole,
                    number: playerNumber
                })
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => console.error("Error:", error));
        } else {
            alert("該帳號無此權限");
        }

    });

    function viewPlayer(name, role, number) {
        alert(`姓名: ${name}\n角色: ${role}\n背號: ${number}`);
    }

    function editPlayer(playerId) {
        alert(`編輯球員 ID: ${playerId}`);
    }

    function deletePlayer(playerId) {
        if (confirm("確定要刪除此球員嗎？")) {
            fetch(`/players/delete/${playerId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
        }
    }

    document.getElementById("startMatchBtn").addEventListener("click", function () {
        //判斷該帳號是否有球隊管理者權限
        let isManager = document.getElementById('manager-data').dataset.isManager === "Y";
        if (isManager) {
            fetch("/manager/players/list")
                .then(response => response.json())
                .then(data => {
                    const playersList = document.getElementById("playersList");
                    playersList.innerHTML = "";
                    data.players.forEach(player => {
                        const checkbox = document.createElement("div");
                        checkbox.classList.add("form-check");
                        checkbox.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="selectedPlayers" value="${player.player_id}" id="player_${player.player_id}">
                        <label class="form-check-label" for="player_${player.player_id}">
                            ${player.player_name} - ${player.role} (#${player.number})
                        </label>
                    `;
                        playersList.appendChild(checkbox);
                    });

                    new bootstrap.Modal(document.getElementById("selectPlayersModal")).show();

                })
                .catch(error => console.error("Error fetching players:", error));
        } else {
            alert("該帳號無此權限");
        }

    });

    document.getElementById("selectPlayersForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const selectedPlayers = [];
        document.querySelectorAll('input[name="selectedPlayers"]:checked').forEach(checkbox => {
            selectedPlayers.push(checkbox.value);
        });

        if (selectedPlayers.length === 0) {
            alert("請至少選擇一名球員！");
            return;
        }

        fetch("/match/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ players: selectedPlayers })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("伺服器回應錯誤");
                }
                return response.text(); // 這裡使用 text()，但不處理回應內容
            })
            .then(() => {
                window.location.href = "/match"; // 🔥 直接跳轉到 `/match`
            })
            .catch(error => console.error("Error starting match:", error));
    });

    document.getElementById("viewMatchesBtn").addEventListener("click", () => {
        window.location.href = "/matchHistory"; // 導向 matchHistory 頁面
    });

    document.getElementById('viewStatsBtn').addEventListener('click', function () {
        window.location.href = '/point/team-stats'; // 導向 API 取得數據並渲染頁面
    });
</script>